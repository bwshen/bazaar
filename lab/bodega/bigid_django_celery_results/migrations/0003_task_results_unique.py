# -*- coding: utf-8 -*-
# Generated by Django 1.10.4 on 2018-02-15 00:40
from __future__ import unicode_literals

from django.db import migrations, models


def delete_duplicate_task_results(apps, schema_editor):
    TaskResult = apps.get_model('celery_results', 'TaskResult')
    values = TaskResult.objects.values('task_id')
    annotations = values.annotate(max_id=models.Max('id'),
                                  count_id=models.Count('id'))
    duplicates = annotations.filter(count_id__gt=1)

    # Sample output of the duplicates variable. Indicates we have
    # one task with multiple TaskResult objects
    # <QuerySet [{'task_id': 'f5c96312-9fa5-4dd9-b85d-78dab4ed964f',
    #             'max_id': 2059810,
    #             'count_id': 2}]
    for duplicate in duplicates:
        results = TaskResult.objects.filter(task_id=duplicate['task_id'])
        first_result = results.filter(id=duplicate['max_id'])
        first_result.delete()


class Migration(migrations.Migration):

    dependencies = [
        ('celery_results', '0002_remove_unique_constraint'),
    ]

    operations = [
        migrations.RunPython(delete_duplicate_task_results,
                             reverse_code=migrations.RunPython.noop),
        migrations.AlterField(
            model_name='taskresult',
            name='task_id',
            field=models.CharField(max_length=255,
                                   unique=True,
                                   verbose_name='task id'),
        ),
    ]
